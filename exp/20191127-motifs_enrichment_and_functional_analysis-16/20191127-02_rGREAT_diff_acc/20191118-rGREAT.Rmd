---
title: "ATAC-Seq: rGREAT"
author: "Deepak Tanwar"
date: "<b>Created on:</b> 2019-11-27 <br> <b>Updated on:</b> `r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: tango
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    keep_md: no
    number_sections: no
    fig_width: 8
    fig_height: 8
    fig_caption: true
    df_print: paged
    code_folding: show
  fontsize: 12pt
  geometry: margin=1in
  documentclass: article
# bibliography: references.bib
link-citations: yes
---

# Library
```{r, message=FALSE, warning=FALSE}
library(rGREAT)
library(SummarizedExperiment)
```

# Data

```{r}
allAtac <- GRanges(read.table("input/PND_Adult_NF_peaks.narrowPeak",
  header = F,
  col.names = c(
    "Chr", "Start", "End", "Name", "Score", "Strand",
    "FoldChange", "negLog10pvalue", "negLog10qvalue",
    "Summit"
  ), stringsAsFactors = F
))

load("./input/atac_diff_chromatin_accessibility.RData")
da <- data.frame(rowData(data), stringsAsFactors = F)
da <- da[da$qvalue <= 0.05 & (da$logFC >= 1 | da$logFC <= -1), ]
da <- merge(data.frame(allAtac)[, 1:6], da, by = "Name")
```

# rGREAT

## Function
```{r}
perform_rGREAT <- function(df, FC, bg, fName) {
  d <- NULL

  if (FC == "pos") {
    d <- df[df$logFC > 0, ]
  } else if (FC == "neg"){
    d <- df[df$logFC < 0, ]
  } else{
    d <- df
  }

  df_GR <- GRanges(d)

  set.seed(123)
  bed <- data.frame(df_GR, stringsAsFactors = F)
  bed <- bed[substr(x = bed$seqnames, start = 1, stop = 3) == "chr", ]
  job <- submitGreatJob(gr = bed, bg = bg, species = "mm10")
  tb <- getEnrichmentTables(job)

  writexl::write_xlsx(
    x = tb$`GO Molecular Function`,
    path = paste0("output/", fName, "_GO_MF.xlsx"),
    col_names = T, format_headers = T
  )
  writexl::write_xlsx(
    x = tb$`GO Biological Process`,
    path = paste0("output/", fName, "_GO_BP.xlsx"),
    col_names = T, format_headers = T
  )
  writexl::write_xlsx(
    x = tb$`GO Cellular Component`,
    path = paste0("output/", fName, "_GO_CC.xlsx"),
    col_names = T, format_headers = T
  )

  return(list(
    table = tb,
    job = job
  ))
}
```

## Background
```{r}
bg <- data.frame(data@rowRanges)
bg <- bg[substr(x = bg$seqnames, start = 1, stop = 3) == "chr", ]
```


## Analysis
```{r}
all <- perform_rGREAT(df = da, FC = "all", bg = bg, fName = "PND15_Adult")
pnd15 <- perform_rGREAT(df = da, FC = "neg", bg = bg, fName = "Adult_Negative")
adult <- perform_rGREAT(df = da, FC = "pos", bg = bg, fName = "Adult_Positive")
```

# Annotation plot

## All
```{r, fig.width = 10, fig.height = 10/3, fig.align = 'center'}
plotRegionGeneAssociationGraphs(all$job)
```


## PND15
```{r, fig.width = 10, fig.height = 10/3, fig.align = 'center'}
plotRegionGeneAssociationGraphs(pnd15$job)
```

## Adult
```{r, fig.width = 10, fig.height = 10/3, fig.align = 'center'}
plotRegionGeneAssociationGraphs(adult$job)
```


# SessionInfo
```{r}
devtools::session_info()
```