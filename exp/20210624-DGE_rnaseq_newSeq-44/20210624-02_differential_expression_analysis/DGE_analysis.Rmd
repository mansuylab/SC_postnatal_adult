---
title: "RNA-Seq: differential expression analysis of controls (lab + literature)"
author: "Deepak Tanwar"
date: "<b>Created on:</b> 2021-06-24 <br> <b>Updated on:</b> `r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: tango
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    keep_md: no
    number_sections: no
    fig_width: 8
    fig_height: 8
    fig_caption: true
    df_print: paged
    code_folding: show
  fontsize: 12pt
  geometry: margin=1in
  documentclass: article
# bibliography: references.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries required

```{r, message=FALSE, warning=FALSE}
library(limma)
library(edgeR)
library(plgINS)
library(sva)
library(ggplot2)
library(dplyr)
library(patchwork)
library(SummarizedExperiment)
library(reshape2)
library(autoplotly)
library(pheatmap)
library(viridis)
library(RColorBrewer)
library(ggplotify)
library(SEtools)
library(DESeq2)
```

# Load salmon object
```{r, message=FALSE, warning=FALSE}
load("input/SC_controls_rnaseq_lab_june2021.tds.RData")
```

# Differeitial analysis using `limma`

## PND8 vs PND15
```{r }
design <- model.matrix(~ 0 + Group + LibPrepBatch,
  data = salmon@phenoData[grep(pattern = "PND8|PND15", x = salmon@phenoData$Group), ]
)
colnames(design) <- gsub(pattern = "Group", replacement = "", x = colnames(design))

y <- DGEList(counts = salmon@gene.counts[, grep(pattern = "PND8|PND15", x = colnames(salmon@gene.counts))])
keep <- filterByExpr(y, design, min.count = 15)
y <- y[keep, ]

en <- as.matrix(vst(round(y$counts), blind = TRUE))
sv <- sva(en, design, n.sv = NULL)$sv
colnames(sv) <- paste0("SV", 1:ncol(sv))
design <- cbind(sv, design)

dds <- calcNormFactors(y)

v <- voom(dds, design = design)

contrast.matrix <- makeContrasts(PND15 - PND8, levels = design)
fit <- lmFit(v)

fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)

pnd8.pnd15 <- as.data.frame(topTable(fit2, coef = 1, number = Inf))
pnd8.pnd15 <- data.frame(Genes = rownames(pnd8.pnd15), pnd8.pnd15, stringsAsFactors = F)
pnd8.pnd15_sig <- pnd8.pnd15[abs(pnd8.pnd15$logFC) >= 1 & pnd8.pnd15$adj.P.Val <= 0.05, ]
```


## PND15 vs PNW21
```{r }
design <- model.matrix(~ 0 + Group + LibPrepBatch,
  data = salmon@phenoData[grep(pattern = "PND15|PNW21", x = salmon@phenoData$Group), ]
)
colnames(design) <- gsub(pattern = "Group", replacement = "", x = colnames(design))

y <- DGEList(counts = salmon@gene.counts[, grep(pattern = "PND15|PNW21", x = colnames(salmon@gene.counts))])
keep <- filterByExpr(y, design, min.count = 15)
y <- y[keep, ]

en <- as.matrix(vst(round(y$counts), blind = TRUE))
sv <- sva(en, design, n.sv = NULL)$sv
colnames(sv) <- paste0("SV", 1:ncol(sv))
design <- cbind(sv, design)

dds <- calcNormFactors(y)
v <- voom(dds, design = design)

contrast.matrix <- makeContrasts(PNW21 - PND15, levels = design)

fit <- lmFit(v)

fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)

pnd15.pnw21 <- as.data.frame(topTable(fit2, coef = 1, number = Inf))
pnd15.pnw21 <- data.frame(Genes = rownames(pnd15.pnw21), pnd15.pnw21, stringsAsFactors = F)
pnd15.pnw21_sig <- pnd15.pnw21[abs(pnd15.pnw21$logFC) >= 1 & pnd15.pnw21$adj.P.Val <= 0.05, ]
```


# `cpm` Counts data and pData

```{r }
y <- DGEList(counts = salmon@gene.counts)
keep <- filterByExpr(y, design, min.count = 15)
y <- y[keep, ]

design <- model.matrix(~ 0 + Group + LibPrepBatch, data = salmon@phenoData)

sv <- svacor(y$counts, mm = design)

dds <- calcNormFactors(y, design = design)
cpm <- cpm(dds, log = T)

data <- list(cpm = cpm, sva = sv$cor, pData = salmon@phenoData)

save(data,
  file = "./output/data_pData.RData", compress = T,
  compression_level = 3
)
```

# Results
```{r }
dea.list <- list(
  `pnd15 vs pnd8` = as.DEA(pnd8.pnd15),
  `pnw21 vs pnd15` = as.DEA(pnd15.pnw21)
)

dea.limma <- list(
  `pnd15 vs pnd8` = pnd8.pnd15,
  `pnw21 vs pnd15` = pnd15.pnw21
)
```


## Save RData files
```{r }
save(dea.list,
  file = "./output/dea_SC_Controls_lab_newSeq.DEA.RData", compress = T,
  compression_level = 3
)

save(dea.limma,
  file = "./output/limma_SC_Controls_lab_newSeq.RData", compress = T,
  compression_level = 3
)

writexl::write_xlsx(x = dea.limma, path = "output/dea_results.xlsx", col_names = T, format_headers = T)
```


# MA plots
## PND15 vs PND8
```{r, warning=FALSE, message=FALSE}
res_8_15 <- pnd8.pnd15
res_8_15$threshold <- as.factor(res_8_15$adj.P.Val < 0.05)

p1 <- ggplot(data = res_8_15, aes(
  x = res_8_15$AveExpr,
  y = res_8_15$logFC,
  colour = threshold
)) +
  geom_point(alpha = 0.5, size = 1.8) +
  geom_hline(aes(yintercept = 0), colour = "blue", size = 1) +
  ylim(c(
    -ceiling(max(abs(res_8_15$logFC))),
    ceiling(max(abs(res_8_15$logFC)))
  )) +
  ggtitle("PND15 vs PND8") +
  labs(subtitle = "loess fit") +
  xlab("Mean expression") +
  ylab("Log2 Fold Change") +
  theme(
    plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5, face = "italic", color = "blue"),
    axis.title.x = element_text(face = "bold", size = 15),
    axis.text.x = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 15),
    legend.text = element_text(size = 14)
  ) +
  scale_colour_discrete(name = "p.adjusted < 0.05") +
  stat_smooth(se = FALSE, method = "loess", color = "red", formula = y ~ x, size = 1)
```

```{r, fig.height=5, fig.width=11}
p1
```

## PNW21 vs PND15
```{r, warning=FALSE, message=FALSE}
res_15_21 <- pnd15.pnw21
res_15_21$threshold <- as.factor(res_15_21$adj.P.Val < 0.05)

p2 <- ggplot(data = res_15_21, aes(
  x = res_15_21$AveExpr,
  y = res_15_21$logFC,
  colour = threshold
)) +
  geom_point(alpha = 0.5, size = 1.8) +
  geom_hline(aes(yintercept = 0), colour = "blue", size = 1) +
  ylim(c(
    -ceiling(max(abs(res_15_21$logFC))),
    ceiling(max(abs(res_15_21$logFC)))
  )) +
  ggtitle("PNW21 vs PND15") +
  labs(subtitle = "loess fit") +
  xlab("Mean expression") +
  ylab("Log2 Fold Change") +
  theme(
    plot.title = element_text(face = "bold", size = 20, hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5, face = "italic", color = "blue"),
    axis.title.x = element_text(face = "bold", size = 15),
    axis.text.x = element_text(face = "bold", size = 12),
    legend.title = element_text(face = "bold", size = 15),
    legend.text = element_text(size = 14)
  ) +
  scale_colour_discrete(name = "p.adjusted < 0.05") +
  stat_smooth(se = FALSE, method = "loess", color = "red", formula = y ~ x, size = 1)
```

```{r, fig.height=5, fig.width=11}
p2
```



# Heatmap of most variable genes
```{r}
xvar <- apply((data$cpm + 1), 1, var)
genes500 <- head(sort(xvar, decreasing = TRUE), n = 500)
x500 <- data$cpm[rownames(data$cpm) %in% names(genes500), ]

pheatmap(x500,
  scale = "row", show_rownames = F, col = viridis(100),
  show_colnames = F, annotation_col = data$pData[, 1:2],
  main = "Clustering of samples based on top 500 variable genes"
)
```


# PCA {.tabset .tabset-pills}

## CPM
```{r, fig.height=8.5, fig.width=11, warning=FALSE, message=FALSE}
plgINS::plPCA(
  x = data$cpm, samples_data = data$pData,
  colorBy = "Group", shapeBy = "LibPrepBatch", add.labels = FALSE
)
```

## SVA normalized
```{r, fig.height=8.5, fig.width=11, warning=FALSE, message=FALSE}
plgINS::plPCA(
  x = data$sva, samples_data = data$pData,
  colorBy = "Group", shapeBy = "LibPrepBatch", add.labels = FALSE
)
```


# References
```{r }
report::cite_packages(session = sessionInfo())
```

# SessionInfo
```{r }
devtools::session_info() %>%
  details::details()
```
