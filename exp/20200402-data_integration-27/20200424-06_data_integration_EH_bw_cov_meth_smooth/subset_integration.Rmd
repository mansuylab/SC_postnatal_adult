---
title: "Integration on 1 chromosome"
author: "Deepak Tanwar"
date: "<b>Created on:</b> 2020-04-20 <br> <b>Updated on:</b> `r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: tango
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    keep_md: no
    number_sections: no
    fig_width: 8
    fig_height: 8
    fig_caption: true
    df_print: paged
    code_folding: show
  fontsize: 12pt
  geometry: margin=1in
  documentclass: article
# bibliography: references.bib
link-citations: yes
---

# Library
```{r, warning = F, message = F}
library(EnrichedHeatmap)
library(circlize)
library(data.table)
library(tidyverse)
library(plgINS)
library(BSgenome.Mmusculus.UCSC.mm10)
library(TxDb.Mmusculus.UCSC.mm10.knownGene)
library(csaw)
library(gUtils)
```

```{r, echo = F}
mylapply <- function(...) {
  if (require(parallel) && .Platform$OS.type == "unix") {
    mclapply(..., mc.preschedule = F)
  }
  else {
    lapply(...)
  }
}
```


# Function to subset data to one chromosome
```{r }
one_chr <- function(input, chr = "chr1") {
  df <- data.frame(input)
  df <- df[df$seqnames == chr, ]
  df$seqnames <- as.character(df$seqnames)
  df_GR <- GRanges(df)
  return(df_GR)
}
```


# Usage

We would need following:

1. CGI information for mm10
2. Genes GRanges from gencode GTF file
3. Methylation from RRBS and WGBS
4. Gene expression values from RNA-Seq (named vector)

# TSS
Here, we extract the promoters for transcripts from RNA-Seq
```{r }
cgi_tss_file <- "./output/cgi_tss_mm10.RData"

if (!file.exists(cgi_tss_file)) {
  cgi_mm10 <- find_CpG(Genome = BSgenome.Mmusculus.UCSC.mm10, Cores = 16)
  names(cgi_mm10) <- paste("CpG", 1:length(cgi_mm10), sep = ":_")
  tss_mm10 <- promoters(TxDb.Mmusculus.UCSC.mm10.knownGene, upstream = 0, downstream = 1)
  save(cgi_mm10, tss_mm10, file = cgi_tss_file)
} else {
  load(cgi_tss_file)
}

tss_mm10 <- one_chr(tss_mm10)
names(tss_mm10) <- tss_mm10$tx_name

# TSS +/- 5000
tss_5k <- promoters(TxDb.Mmusculus.UCSC.mm10.knownGene, upstream = 5000, downstream = 5000)
tss_5k <- one_chr(tss_5k)
names(tss_5k) <- tss_5k$tx_name
# tss_5k <- slidingWindows(x = tss_5k, width = 50, step = 50)
# tss_5k <- unlist(tss_5k)
# names(tss_5k) <- gsub(pattern = "\\.EN.*" , replacement = "" , x = names(tss_5k))
# tss_5k$tx_name <- names(tss_5k)
```

The task of visualization are separated into two steps:

1. To get association between genomic signals and targets by normalizing into a matrix.
2. To visualize the matrix by heatmap.


# Normalize signal to tss

`normalizeToMatrix()` converts the association between genomic signals (H3K4me3) and targets(tss) into a matrix (actually mat1 is just a normal matrix with several additional attributes). It first splits the extended targets regions (the extension to upstream and downstream is controlled by extend argument) into a list of small windows (the width of the windows is controlled by w), then overlaps genomic signals to these small windows and calculates the value for every small window, which is the mean value of genomic signals that intersects with the window (the value corresponds to genomic signals are controlled by value_column and how to calcualte the mean value is controlled by mean_mode).


## ATAC-Seq
```{r }
nm_atac <- "./output/subset/mat_atac.RData"

if (!file.exists(nm_atac)) {
  atac_files <- list.files("input/atacseq", pattern = "\\.bw$", full.names = TRUE)
  names(atac_files) <- gsub(pattern = "\\.bw", replacement = "", x = basename(atac_files))
  atac_bw <- mylapply(atac_files, function(x) rtracklayer::import(x, selection = tss_5k))

  mat_AS <- mylapply(atac_bw, FUN = function(x) {
    normalizeToMatrix(x, tss_mm10,
      extend = 5000,
      value_column = "score",
      include_target = TRUE
    )
  }, mc.cores = length(atac_files))

  save(mat_AS, file = nm_atac)
} else {
  load(nm_atac)
}
```


## ChIP-Seq
```{r }
nm_chip <- "./output/subset/mat_chip.RData"

if (!file.exists(nm_chip)) {
  chip_files <- list.files("input/chipseq", pattern = "\\.bw$", full.names = TRUE)
  names(chip_files) <- gsub(pattern = "\\.bw", replacement = "", x = basename(chip_files))
  chip_bw <- mylapply(chip_files, function(x) rtracklayer::import(x, selection = tss_5k))

  mat_CS <- mylapply(chip_bw, FUN = function(x) {
    normalizeToMatrix(x, tss_mm10,
      extend = 5000,
      value_column = "score",
      include_target = TRUE
    )
  }, mc.cores = length(chip_files))

  save(mat_CS, file = nm_chip)
} else {
  load(nm_chip)
}
```


## Bisulphite-Seq
```{r}
nm_bs <- "./output/subset/mat_bs.RData"

if (!file.exists(nm_bs)) {
  bs_files <- list.files("input/bsseq", pattern = "\\.gz$", full.names = TRUE)
  names(bs_files) <- gsub(pattern = "_1_val_1_bismark_bt2_pe.bismark.cov.gz", 
                          replacement = "", x = basename(bs_files))
  
  bs_cov <- mylapply(bs_files, function(x) fread(
    input = x,
    sep = "\t", quote = F, stringsAsFactors = F, 
    data.table = FALSE, nThread = detectCores(), showProgress = F,
    col.names = c("seqnames", "start", "end", "percent", "Me", "Un")
  ), mc.cores = length(bs_files))
  
  bs_cov <- mylapply(bs_cov, function(x) {
    a <- one_chr(GRanges(x))
    a$meth <- a$percent / 100
    a <-a[, 4]  
    return(a)
  }, mc.cores = length(bs_files))
  
  
  mat_BS <- mylapply(bs_cov, FUN = function(x) {
    normalizeToMatrix(x, tss_mm10,
      extend = 5000,
      value_column = "meth",
      include_target = TRUE
    )
  }, mc.cores = length(bs_files))

  save(mat_BS, file = nm_bs)
} else {
  load(nm_bs)
}
```


## RRBS
```{r}
nm_rrbs <- "./output/subset/mat_rrbs.RData"

if (!file.exists(nm_rrbs)) {
  rrbs_files <- list.files("input/rrbs", pattern = ".gz", full.names = T)
  names(rrbs_files) <- gsub(pattern = "_trimmed_bismark_bt2.bismark.cov.gz", 
                          replacement = "", x = basename(rrbs_files))
  
  rrbs_cov <- lapply(rrbs_files, function(x) fread(
    input = x,
    sep = "\t", quote = F, stringsAsFactors = F, 
    data.table = FALSE, nThread = 4, showProgress = F,
    col.names = c("seqnames", "start", "end", "percent", "Me", "Un")
  ))
  
  rrbs_cov <- mylapply(rrbs_cov, function(x) {
    a <- one_chr(GRanges(x))
    a$meth <- a$percent / 100
    a <-a[, 4]  
    return(a)
  }, mc.cores = length(rrbs_files))

    mat_RRBS <- mylapply(rrbs_cov, FUN = function(x) {
    normalizeToMatrix(x, tss_mm10,
      extend = 5000,
      value_column = "meth",
      include_target = TRUE
    )
  }, mc.cores = length(rrbs_files))


  save(mat_RRBS, file = nm_rrbs)
} else {
  load(nm_rrbs)
}
```

## RNA-Seq
```{r }
nm_rna <- "./output/subset/mat_rna.RData"

if (!file.exists(nm_rna)) {
  rna_files <- list.files("input/rnaseq", pattern = "\\.bw$", full.names = TRUE)
  names(rna_files) <- gsub(pattern = "\\.bw", replacement = "", x = basename(rna_files))
  rna_bw <- mylapply(rna_files, function(x) rtracklayer::import(x, selection = tss_5k))

  mat_RNA <- mylapply(rna_bw, FUN = function(x) {
    normalizeToMatrix(x, tss_mm10,
      extend = 5000,
      value_column = "score",
      include_target = TRUE
    )
  }, mc.cores = length(rna_files))

  save(mat_RNA, file = nm_rna)
} else {
  load(nm_rna)
}
```


# Heatmaps

## Function
```{r }
create_heatmap <- function(nc = 4) {
  set.seed(11111)

  pdf_file <- paste0("./output/subset/heatmap_atac_chip_cluster_", nc, ".pdf")

  if (!file.exists(pdf_file)) {
    partition <- paste0("cluster", kmeans(log1p(mat_AS$Adult_NF), centers = nc)$cluster)

    lgd <- Legend(
      at = paste0("cluster", 1:nc), title = "Clusters",
      type = "lines", legend_gp = gpar(col = 2:(nc + 1))
    )

    hm_partition <- Heatmap(partition,
      col = structure(2:(nc + 1), names = paste0("cluster", 1:nc)),
      name = "partition", show_row_names = FALSE, width = unit(5, "mm")
    )

    # an_atac <- HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1)), ylim = c(0, 5)))

    # col_gatac <- colorRamp2(c(0, 2.5, 5), c("blue", "white", "red"))

    # ATAC-Seq
    hm_atac <- EnrichedHeatmap(log1p(mat_AS$Adult_NF),
      name = "Adult ATAC",
      # col = col_atac,
      column_title = "Adult ATAC",
      # top_annotation = an_atac
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) +
      EnrichedHeatmap(log1p(mat_AS$PND15_NF),
        name = "PND15 ATAC",
        # col = col_atac,
        column_title = "PND15 ATAC",
        # top_annotation = an_atac
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      )

    
    # ChIP-Seq
    hm_chip <- EnrichedHeatmap(log1p(mat_CS$PNW8_H3K4me3_SRX332343),
      name = "Adult H3K4me3",
      # col = c("white", "#0f456e"),
      column_title = "Adult H3K4me3",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) +
      EnrichedHeatmap(log1p(mat_CS$PNW8_H3K27me3_SRX332346),
        name = "Adult H3K27me3",
        # col = c("white", "#671787"),
        column_title = "Adult H3K27me3",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(log1p(mat_CS$PNW8_H3K27ac_SRX332351),
        name = "Adult H3K27ac",
        # col = c("white", "#b83018"),
        column_title = "Adult H3K27ac",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      )

    
    # BSseq
    hm_bs <- EnrichedHeatmap(mat_BS$PNW8_SRX6885_95_96,
        name = "PNW8 BS",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      )

    
    # RRBS
    hm_rrbs <- EnrichedHeatmap(mat_RRBS$PND8,
      name = "PND8 RRBS",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    )
    
    # RNA-Seq
    hm_rna <- EnrichedHeatmap(mat_RNA$Adult,
      name = "Adult RNA",
      # col = c("white", "#ba1168"),
      column_title = "Adult RNA",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) +
      EnrichedHeatmap(mat_RNA$PND15,
        name = "PND15 RNA",
        # col = c("white", "#ba1168"),
        column_title = "PND15 RNA",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(mat_RNA$PND8,
        name = "PND8 RNA",
        # col = c("white", "#ba1168"),
        column_title = "PND8 RNA",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      )



    pdf(file = pdf_file, width = 22, height = 17)

    if (nc == 1) {
      ht_list <- hm_atac + hm_chip + hm_bs + hm_rrbs + hm_rna
      draw(ht_list, ht_gap = unit(2, "mm"))
    } else {
      ht_list <- hm_partition + hm_atac + hm_chip + hm_bs + hm_rrbs + hm_rna
      draw(ht_list,
        split = partition, annotation_legend_list = list(lgd),
        ht_gap = unit(2, "mm")
      )
    }

    dev.off()
    invisible(gc())
  }
}
```

## Make heatmaps
```{r }
mylapply(1:10, create_heatmap, mc.cores = 3)
```

# Test

## RRBS
```{r}
pdf(file = "output/subset/rrbs.pdf", width = 22, height = 17)
hm_rrbs <- EnrichedHeatmap(mat_RRBS$PND8,
      name = "PND8 RRBS",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) + 
      EnrichedHeatmap(mat_RRBS$PND8_02_1,
      name = "PND8 RRBS 1",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS 1",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) + 
      EnrichedHeatmap(mat_RRBS$PND8_10_1,
      name = "PND8 RRBS 2",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS 2",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) + 
      EnrichedHeatmap(mat_RRBS$PND8_13_2,
      name = "PND8 RRBS 3",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS 3",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) + 
      EnrichedHeatmap(mat_RRBS$PND8_15_1,
      name = "PND8 RRBS 4",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS 4",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) + 
      EnrichedHeatmap(mat_RRBS$PND8_15_2,
      name = "PND8 RRBS 5",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS 5",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) + 
      EnrichedHeatmap(mat_RRBS$PND8_23_1,
      name = "PND8 RRBS 6",
      # col = c("white", "#ba1168"),
      column_title = "PND8 RRBS 6",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    )

draw(hm_rrbs, ht_gap = unit(2, "mm"))

dev.off()
```


## BS
```{r}
pdf(file = "output/subset/bs.pdf", width = 22, height = 17)
hm_bs <- EnrichedHeatmap(mat_BS$PND7_SRX749887,
      name = "PND7 BS",
      # col = c("white", "#ba1168"),
      column_title = "PND7 BS",
      top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
    ) +
      EnrichedHeatmap(mat_BS$PND14_SRX749892,
        name = "PND14 BS",
        # col = c("white", "#ba1168"),
        column_title = "PND14 BS",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(mat_BS$PNW8_SRX688595,
        name = "PNW8 BS 1",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS 1",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(mat_BS$PNW8_SRX688596,
        name = "PNW8 BS 2",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS 2",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) + 
      EnrichedHeatmap(mat_BS$PNW8_SRX688590,
        name = "PNW8 BS 3",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS 3",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(mat_BS$PNW8_SRX688591,
        name = "PNW8 BS 4",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS 4",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) + 
      EnrichedHeatmap(mat_BS$PNW8_SRX688592,
        name = "PNW8 BS 5",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS 5",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) + 
      EnrichedHeatmap(mat_BS$PNW8_SRX688593,
        name = "PNW8 BS 6",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS 6",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(mat_BS$PNW8_SRX688594,
        name = "PNW8 BS 7",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS 7",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(mat_BS$PNW8,
        name = "PNW8 BS",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      ) +
      EnrichedHeatmap(mat_BS$PNW8_SRX6885_95_96,
        name = "PNW8 BS 1 & 2",
        # col = c("white", "#ba1168"),
        column_title = "PNW8 BS  1 & 2",
        top_annotation = HeatmapAnnotation(lines = anno_enriched(gp = gpar(col = 2:(nc + 1))))
      )
draw(hm_bs, ht_gap = unit(2, "mm"))
dev.off()
```

## Convert to PNG
```{r subset-integration-10, eval = FALSE}
pdf <- list.files(path = "output", pattern = "pdf", recursive = T, full.names = T)
png <- mylapply(pdf, function(x) {
  pdftools::pdf_convert(
    pdf = x, format = "png", dpi = 200,
    filenames = gsub(pattern = ".pdf", replacement = ".png", x = x)
  )
}, mc.cores = length(pdf))
```

# Heatmaps
```{r subset-integration-11, echo=FALSE}
plots <- list.files(path = "output/subset", pattern = "png", full.names = TRUE)
plots <- plots[grep(pattern = "heat", x = plots)]

names(plots) <- sapply(plots, function(x){
  n <- as.numeric(gsub(pattern = "\\..*|.*_cluster_", replacement = "", x = x))
  if(n ==1){
    return("No clustering")
  } else{
    return(paste("Cluster:", sprintf("%01d", n)))
  }
})

plots <- plots[c(2:10, 1)]

bs <- bsselectR::bsselect(plots, type = "img", live_search = TRUE, show_tick = TRUE)

bsselectR::as_iframe(widget = bs, file = "v4.html")
```

# SessionInfo
```{r subset-integration-12 }
devtools::session_info()
```
